digraph diagram {
  label = "Mu2e Data Processing (Pass 1)";
  fontname="Helvetica";
  fontsize="36";
  labelloc = t;
  subgraph clusterLegend {
    rankdir=TB;
    color="black";
    label="Legend";
    fontsize="24";

    process [shape=ellipse,color=black,
            label=<<table border="0" cellborder="0" cellspacing="1">
              <tr><td align="center"><b>Process</b></td></tr>
              </table>>];
    storage [shape=box,color=black,
            label=<<table border="0" cellborder="0" cellspacing="1">
              <tr><td align="center"><b>Data Storage</b></td></tr>
              <tr><td align="left"><b><font color="fuchsia">ephemeral</font></b></td></tr>
              <tr><td align="left"><font color="cyan">scratch</font></td></tr>
              <tr><td align="left"><font color="blue">persistent</font></td></tr>
              <tr><td align="left"><font color="black">tape</font></td></tr>
              <tr><td align="left"><font color="green">other</font></td></tr>
              </table>>];
    subgraph clustertype {
      label="Data Format";
      fontsize=16;
      raw [shape=parallelogram, label = "Fragment" ];
      digi [shape=pentagon, lable = "Reco" ];
      reco [shape=box, lable = "Reco" ];
      tuple [shape=hexagon, lable = "Tuple" ];
      other [shape=trapezium, lable = "Other" ];
    }

  }

  DAQ [
    label = "DAQ",
          shape= ellipse
  ];
  ConditionsDB [ label = "Conditions Database",
               shape = trapezium, color=green
  ];
  ConditionsDB -> DAQ [constraint=false];
  {rank=same ConditionsDB DAQ};

  // primary inputs, from DAQ
  OffSpillFragments [
    label = "OffSpill",
          shape = parallelogram
  ];
  OnSpillFragments [
    label = "OnSpill",
          shape = parallelogram
  ]
  DAQ->OffSpillFragments
  DAQ->OnSpillFragments
  // temporary on-disk samples
  //  - ephemeral collections, e.g. salt
  //  - accumulating collections, e.g. reconstructed signal-likes
  OnSpillHidden [
    label = "OnSpill Physics (hidden)",
    shape = box,
    color="fuchsia"
  ];
  OffSpillPhysics [
    label = "OffSpill Physics",
    shape = box,
    color="black"
  ];
  SaltTracks [
    label = "Salt tracks",
    shape = box,
    color="fuchsia"
  ];
  SaltEvents [
    label = "Salt events",
    shape = box,
    color="fuchsia"
  ];
  OffSpillDetectorCalib [
    label = "OffSpill Detector",
    shape = box,
    peripheries=3,
    color="blue"
  ];
  OnSpillDetectorCalib [
    label = "OnSpill Detector",
    shape = box,
    peripheries=3,
    color="blue"
  ];
  OnSpillNZS [
    label = "OnSpill NZS",
    shape=pentagon,
    color="cyan"
  ];
  OffSpillNZS [
    label = "OffSpill NZS",
    shape=pentagon,
    color="cyan"
  ];
  Other [
    label = "Other Physics"
      shape = hexagon,
            peripheries=3,
            color=blue
  ];

  HighPNegative [
    label = "High-P e-",
          shape = hexagon,
          color = blue
  ];
  HighPPositive [
    label = "High-P e+",
          shape = hexagon,
          color = blue
  ];
  MultiTrack [
    label = "Multitrack",
          shape = hexagon,
          color = blue
  ];
  OnSpillPhysics [
    label = "OnSpill Physics",
          shape = box,
          color = black
  ];

  // TODO
  // monitoring /ation plots and database

  // tape-backed storage
  Pileup [
    label = "Pileup",
          shape = box
  ];
  DetCalib [
    label = "Detector Calib",
    shape = hexagon,
    peripheries=3,
    color=cyan
  ];

  DetMonPlots [
    label = "Detector Monitor Plots",
    shape = trapezium,
    peripheries=3,
    color=blue
  ];

  PhysMonPlots [
    label = "Physics Monitor Plots",
    shape = trapezium,
    peripheries=3,
    color=blue
  ];

  DetDBTable [
    label = "Det DB Table",
          shape = trapezium,
          peripheries=3,
          color=cyan
  ];

  CRVDBTable [
    label = "CRV DB Table",
          shape = trapezium,
          peripheries=3,
          color=cyan
  ];
  {rank=same DetDBTable CRVDBTable}
  {rank=same OffSpillPhysics };

  // online high-level processing blocks
  OffSpillReco [
    label = "OffSpill Reco"
      shape = oval
  ];
  OnSpillReco [
    label = "OnSpill Reco"
      shape = oval
  ];

  // offline high-level processing blocks
  DetectorCalibSelect [
    label = "Detector Calib Select",
          peripheries=3,
          shape = oval
  ];

  DetectorCalibExtract [
    label = "Detector Calibration Extract",
          peripheries=3,
          shape = oval
  ];

  DetectorMonitoring [
    label = "Detector Monitoring",
    shape = oval
  ];


  SaltOverlay [
    label = "Salt + Pileup Overlay",
          shape = oval
  ];
  PhysicsMerging [
    label = "Physics Merge and Sort",
          shape = oval
  ];

  // TODO
  //ation processors and preprocessors

  // dependencies
  OffSpillFragments -> OffSpillReco;
  OnSpillFragments  -> OnSpillReco;

  // ejc: no offSpill ``physics'' sample here?
  OffSpillReco -> OffSpillPhysics [label="Physics Selector"];
  OffSpillReco -> SaltTracks [label="Salt Selector" ];
  OffSpillReco -> OffSpillDetectorCalib [label="Detector Selector"];
  OffSpillReco -> OffSpillNZS [label="NZS Selector"];

  OnSpillReco -> OnSpillHidden [label="Physics Selector"];
  OnSpillReco -> Pileup [label="Pileup Selector"];
  OnSpillReco -> OnSpillDetectorCalib [label="Detector Selector"];
  OnSpillReco -> OnSpillNZS [label="NZS Selector"];

  OffSpillDetectorCalib    -> DetectorCalibSelect;
  OnSpillDetectorCalib     -> DetectorCalibSelect;

  OffSpillDetectorCalib    -> DetectorMonitoring
  OnSpillDetectorCalib     -> DetectorMonitoring;

  DetectorCalibSelect ->DetCalib;
  DetCalib -> DetectorCalibExtract;
  DetectorCalibExtract -> DetDBTable;
//  DetDBTable -> ConditionsDB [label="Calibration Verification"];
  DetDBTable -> ConditionsDB;

  DetectorMonitoring -> DetMonPlots;

  OffSpillNZS -> CRVCalibExtract;
  OnSpillNZS -> CRVCalibExtract;
  CRVCalibExtract -> CRVDBTable;
//  CRVDBTable -> ConditionsDB [label="Calibration Verification"];
  CRVDBTable -> ConditionsDB;

  SaltTracks        -> SaltOverlay;
  Pileup -> SaltOverlay;
  SaltOverlay       -> SaltEvents;


  OnSpillHidden       -> PhysicsMerging;
  SaltEvents         -> PhysicsMerging;

  PhysicsMerging -> OnSpillPhysics;
  PhysicsMerging -> HighPNegative;
  PhysicsMerging -> HighPPositive;
  PhysicsMerging -> MultiTrack;
  PhysicsMerging -> Other;

  OffSpillPhysics -> PhysicsMonitoring;
  OnSpillPhysics -> PhysicsMonitoring;
  PhysicsMonitoring -> PhysMonPlots;

}
