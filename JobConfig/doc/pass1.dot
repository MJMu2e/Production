digraph diagram {
  label = "Mu2e Data Processing (Pass 1)";
  fontname="Helvetica";
  fontsize="36";
  labelloc = t;
  subgraph clusterLegend {
    rankdir=TB;
    color="black";
    label="Legend";
    fontsize="24";

    process [shape=ellipse,color=black,
            label=<<table border="0" cellborder="0" cellspacing="1">
              <tr><td align="center"><b>Process</b></td></tr>
              </table>>];
    storage [shape=box,color=black,
            label=<<table border="0" cellborder="0" cellspacing="1">
              <tr><td align="center"><b>Data Storage</b></td></tr>
              <tr><td align="left"><b><font color="fuchsia">ephemeral</font></b></td></tr>
              <tr><td align="left"><font color="cyan">scratch</font></td></tr>
              <tr><td align="left"><font color="blue">persistent</font></td></tr>
              <tr><td align="left"><font color="black">tape</font></td></tr>
              <tr><td align="left"><font color="green">other</font></td></tr>
              </table>>];
    subgraph clustertype {
      label="Data Format";
      fontsize=16;
      raw [shape=parallelogram, label = "Fragment" ];
      reco [shape=box, lable = "Reco" ];
      tuple [shape=hexagon, lable = "Tuple" ];
      other [shape=trapezium, lable = "Other" ];
    }

  }

  DAQ [ label = "DAQ",
      shape= ellipse
  ];
  ConditionsDB [ label = "Conditions Database",
  shape = trapezium, color=green
  ];
  ConditionsDB -> DAQ [constraint=false];
  {rank=same ConditionsDB DAQ};

  // primary inputs, from DAQ
  OffSpillFragments
    [
    label = "OffSpill",
          shape = parallelogram
    ];
  OnSpillFragments
    [
    label = "OnSpill",
          shape = parallelogram
    ]
  DAQ->OffSpillFragments
  DAQ->OnSpillFragments
  // temporary on-disk samples
  //  - ephemeral collections, e.g. salt
  //  - accumulating collections, e.g. reconstructed signal-likes
  OnSpillPhysics
    [
    label = "OnSpill Physics",
          shape = box,
          color="fuchsia"
    ];
  OffSpillPhysics
    [
    label = "OffSpill Physics",
          shape = box,
          color="black"
    ];
  SaltTracks
    [
    label = "Salt tracks",
          shape = box,
          color="fuchsia"
    ];
  SaltEvents
    [
    label = "Salt events",
          shape = box,
          color="fuchsia"
    ];
  OffSpillTrackerCalib
    [
    label = "OffSpill Tracker",
          shape = box,
          color="blue"
    ];
  OffSpillCaloCalib
    [
    label = "OffSpill calo.",
          shape = box,
          color="blue"
    ];
  OnSpillTrackerCalib
    [
    label = "OnSpill tracker",
          shape = box,
          color="blue"
    ];
  OnSpillCaloCalib
    [
    label = "OnSpill Calo.",
          shape = box,
          color="blue"
    ];
  OnSpillNZS
    [
    label = "OnSpill NZS",
          shape=parallelogram,
    ];
  OffSpillNZS
    [
    label = "OffSpill NZS",
          shape=parallelogram,
    ];
  HighPNegative
    [
    label = "High-P electron",
          shape = box
    ];
  HighPPositive
    [
    label = "High-P positron",
          shape = box
    ];
  MultiTrack
    [
    label = "Multitrack",
          shape = box
    ];

  // TODO
  // monitoring /ation plots and database

  // tape-backed storage
  Pileup [
    label = "Pileup",
          shape = box
  ];
  TrkCalib [
    label = "Trk Calib",
          shape = hexagon,
          peripheries=3,
          color=cyan
  ];
  TrkDBTable [
    label = "Trk DB Table",
          shape = trapezium,
          peripheries=3,
          color=cyan
  ];

  CaloCalib [
    label = "Cal Calib",
          shape = hexagon,
          peripheries=3,
          color=cyan
  ];
  CaloDBTable [
    label = "Calo DB Table",
          shape = trapezium,
          peripheries=3,
          color=cyan
  ];
  CRVDBTable [
    label = "CRV DB Table",
          shape = trapezium,
          peripheries=3,
          color=cyan
  ];
 {rank=same TrkDBTable CaloDBTable CRVDBTable}
  AllPhysics [
    label = "All Physics"
      shape = box
      shape = hexagon,
            peripheries=3,
            color=cyan
  ];
  {rank=same OffSpillPhysics AllPhysics};

  // online high-level processing blocks
  OffSpillReco
    [
    label = "OffSpill Coarse reco"
      shape = oval
    ];
  OnSpillReco
    [
    label = "OnSpill Coarse reco"
      shape = oval
    ];

  // offline high-level processing blocks
  TrackerCalibSelect
    [
    label = "Tracker Calib Select",
          peripheries=3,
          shape = oval
    ];
  CaloCalibSelect
    [
    label = "Calo Calib Select",
          peripheries=3,
          shape = oval
    ];

  TrackerCalibExtract
    [
    label = "Tracker Calibration Extract",
          peripheries=3,
          shape = oval
    ];
  CaloCalibExtract
    [
    label = "Calo Calibration Extract",
          peripheries=3,
          shape = oval
    ];

  SaltOverlay
    [
    label = "Salt + Pileup overlay",
          shape = oval
    ];
  PhysicsMerging
    [
    label = "Physics Merge and Select",
          shape = oval
    ];

  // TODO
  //ation processors and preprocessors

  // dependencies
  OffSpillFragments -> OffSpillReco;
  OnSpillFragments  -> OnSpillReco;

  // ejc: no offSpill ``physics'' sample here?
  OffSpillReco -> OffSpillPhysics [label="Physics Selector"];
  OffSpillReco -> SaltTracks [label="Salt Selector" ];
  OffSpillReco -> OffSpillTrackerCalib [label="Tracker Selector"];
  OffSpillReco -> OffSpillCaloCalib [label="Calo Selector"];
  OffSpillReco -> OffSpillNZS [label="NZS Selector"];

  OnSpillReco -> OnSpillPhysics [label="Physics Selector"];
  OnSpillReco -> Pileup [label="Pileup Selector"];
  OnSpillReco -> OnSpillTrackerCalib [label="Tracker Selector"];
  OnSpillReco -> OnSpillCaloCalib [label="Calo Selector"];
  OnSpillReco -> OnSpillNZS [label="NZS Selector"];

  OffSpillTrackerCalib    -> TrackerCalibSelect;
  OnSpillTrackerCalib     -> TrackerCalibSelect;
  OffSpillCaloCalib       -> CaloCalibSelect;
  OnSpillCaloCalib        -> CaloCalibSelect;

  TrackerCalibSelect ->TrkCalib;
  TrkCalib -> TrackerCalibExtract;
  TrackerCalibExtract -> TrkDBTable
  TrkDBTable -> ConditionsDB [label="Calibration Verification"]

  CaloCalibSelect -> CaloCalib;
  CaloCalib -> CaloCalibExtract;
  CaloCalibExtract -> CaloDBTable
  CaloDBTable -> ConditionsDB [label="Calibration Verification"]

  OffSpillNZS -> CRVCalibExtract;
  OnSpillNZS -> CRVCalibExtract;
  CRVCalibExtract -> CRVDBTable
  CRVDBTable -> ConditionsDB [label="Calibration Verification"]

  SaltTracks        -> SaltOverlay;
  Pileup -> SaltOverlay;
  SaltOverlay       -> SaltEvents;


  OnSpillPhysics       -> PhysicsMerging;
  SaltEvents         -> PhysicsMerging;

  PhysicsMerging -> AllPhysics;
  PhysicsMerging -> HighPNegative;
  PhysicsMerging -> HighPPositive;
  PhysicsMerging -> MultiTrack;
}
